---
title: '08-TypeORM-Theory'
date: 2023/12/25
---

## 1. Typeormê³µë¶€ìš© í”„ë¡œì íŠ¸

Typeormê³µë¶€ìš© ìƒˆ í”„ë¡œì íŠ¸ë¥¼ ë§Œë“­ì‹œë‹¤.

```bash
nest new typeorm
yarn add @nestjs/typeorm typeorm pg
```

```dockerfile docker-compose.yaml
# ì„œë¹„ìŠ¤ì •ì˜
services:
  postgres:
    image: postgres:15
    # ì‹¤í–‰ì‹œë§ˆë‹¤ ì¬ì‹œì‘
    restart: always
    # ë„ì»¤ì»´í¬ì¦ˆ íŒŒì¼ì— ì¡´ì¬í•˜ëŠ” ìœ„ì¹˜ì— ì‹¤ì œ ë°ì´í„°ë¥¼ hostOSì— ì €ì¥
    volumes:
      # í˜„ì¬ ë„ì»¤ì»´í¬ì¦ˆ íŒŒì¼ì´ ì¡´ì¬í•˜ëŠ” ê²½ë¡œ : ì´ë¯¸ì§€ì•ˆì—ì¡´ì¬í•˜ëŠ” ê²½ë¡œ ë§¤í•‘
      - ./postgres-data:/var/lib/postgresql/data
    ports:
      # hostport:ì´ë¯¸ì§€ì˜í¬íŠ¸
      # 5432í¬íŠ¸ ìš”ì²­ -> ì´ë¯¸ì§€ì˜ í¬íŠ¸ë¡œ ìš”ì³¥
      - '5808:5432'
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: typeormstudy
```

```ts app.module.ts
import { Module } from '@nestjs/common'
import { TypeOrmModule } from '@nestjs/typeorm'

import { AppController } from './app.controller'
import { AppService } from './app.service'

@Module({
  imports: [
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ PostsModel ê°€ì ¸ì˜¤ê¸°
      entities: [],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

---

## 2. Column Annotationë“¤

`src/entity/user.entity.ts` íŒŒì¼ì„ ë§Œë“­ë‹ˆë‹¤.

```ts user.entity.ts
import {
  Column,
  CreateDateColumn,
  Entity,
  Generated,
  PrimaryGeneratedColumn,
  UpdateDateColumn,
  VersionColumn,
} from 'typeorm'

@Entity()
export class UserModel {
  /*** ID
   * ìë™ìœ¼ë¡œ IDë¥¼ ìƒì„±í•œë‹¤.
   *
   * ğŸ“Œ @PrimaryGeneratedColumn()
   * Primary Columnì€ ëª¨ë“  í…Œì´ë¸”ì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ ì¡´ì¬í•´ì•¼ í•œë‹¤
   * í…Œì´ë¸” ì•ˆì—ì„œ ê°ê°ì˜ Rowë¥¼ êµ¬ë¶„í•  ìˆ˜ ìˆëŠ” ì»¬ëŸ¼ì´ë‹¤.
   * @PrimaryColumn()
   *
   * ğŸ“Œ @PrimaryGeneratedColumn('uuid')
   * PrimaryGeneratedColumn => ìˆœì„œëŒ€ë¡œ ìœ„ë¡œ ì˜¬ë¼ê°„ë‹¤.
   * 1, 2, 3, 4, 5 -> 999999
   *
   * UUID : ì ˆëŒ€ë¡œ ê²¹ì¹˜ì§€ ì•ŠëŠ” ê³ ìœ í•œ ê°’ì„ ë§Œë“¤ì–´ì¤Œ
   * ea36ed96-8d1c-44d9-9fbe-4ec6960e95a8
   */
  @PrimaryGeneratedColumn()
  id: number

  @Column()
  title: string

  /** ë°ì´í„° ìƒì„± ì¼ì
   * ë°ì´í„°ê°€ ìƒì„±ë˜ëŠ” ë‚ ì§œì™€ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì°íŒë‹¤.
   */
  @CreateDateColumn()
  createdAt: Date

  /** ë°ì´í„° ìˆ˜ì • ì¼ì
   * ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ëŠ” ë‚ ì§œì™€ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ì°íŒë‹¤.
   */
  @UpdateDateColumn()
  updateAt: Date

  /** ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ ë  ë–„ë§ˆë‹¤ 1ì”© ì˜¬ë¼ê°„ë‹¤
   * ì²˜ìŒ ìƒì„±ë˜ë©´ ê°’ì€ 1ì´ë‹¤.
   * save() í•¨ìˆ˜ê°€ ëª‡ ë²ˆ ë¶ˆë ¸ëŠ”ì§€ ê¸°ì–µí•œë‹¤.
   */
  @VersionColumn()
  version: number

  /**
   * ğŸ“Œ @Generated('increment')
   * additionalId: number
   * PrimaryColumnì€ ì•„ë‹Œë°, ë°ì´í„° ìƒì„±í•  ë–„ë§ˆë‹¤, 1ì”© ì˜¬ë¼ê°€ëŠ” ì»¬ëŸ¼
   *
   * ğŸ“Œ Generated('uuid')
   * additionalId: string
   * ëŠ” ë§ˆì°¬ê°€ì§€ë¡œ,
   * PrimaryColumnì€ ì•„ë‹Œë°, ë°ì´í„° ìƒì„±í•  ë–„ë§ˆë‹¤, ê³ ìœ ê°’ì„ ê°€ì§€ëŠ” ì»¬ëŸ¼
   */
  @Column()
  @Generated('uuid')
  additionalId: string
}
```

```ts app.module.ts
import { Module } from '@nestjs/common'
import { TypeOrmModule } from '@nestjs/typeorm'

import { AppController } from './app.controller'
import { AppService } from './app.service'
import { UserModel } from './entity/user.entity'

@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [UserModel],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

```ts app.controller.ts
import { Controller, Get, Param, Patch, Post } from '@nestjs/common'
import { InjectRepository } from '@nestjs/typeorm'
import { UserModel } from './entity/user.entity'
import { Repository } from 'typeorm'

@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
  ) {}

  @Post('users')
  postUser() {
    return this.userRepository.save({
      title: 'test title',
    })
  }

  @Get('users')
  getUsers() {
    return this.userRepository.find()
  }

  @Patch('users/:id')
  async patchUser(@Param('id') id: string) {
    const user = await this.userRepository.findOne({
      where: { id: parseInt(id) },
    })

    return this.userRepository.save({
      ...user,
      title: user.title + '0',
    })
  }
}
```

---

## 3. Column Property ì •ë¦¬

```ts user.entity.ts
// user.entity.ts ìƒëµ
@Column({
  // ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¸ì§€í•˜ëŠ” ì»¬ëŸ¼ íƒ€ì… (ìë™ìœ¼ë¡œ ìœ ì¶”ë¨)
  type: 'varchar',
  // ë°ì´í„°ë² ì´ìŠ¤ ì¹¼ëŸ¼ ì´ë¦„ (í”„ë¡œí¼í‹° ì´ë¦„ìœ¼ë¡œ ìë™ ìœ ì¶”ë¨)
  name: 'title',
  // ê°’ì˜ ê¸¸ì´(ì…ë ¥í•  ìˆ˜ ìˆëŠ” ê¸€ìì˜ ê¸¸ì´ê°€ 300)
  length: 300,
  // nullì´ ê°€ëŠ¥í•œì§€
  nullable: true,
  // trueë©´ ì²˜ìŒ ì €ì¥í•  ë•Œë§Œ ê°’ ì§€ì • ê°€ëŠ¥(ì´í›„ì—ëŠ” ê°’ ë³€ê²½ ë¶ˆê°€ëŠ¥)
  update: true,
  // find()ë¥¼ ì‹¤í–‰í•  ë–„, ê¸°ë³¸ìœ¼ë¡œ ê°’ì„ ë¶ˆëŸ¬ì˜¬ì§€ (ê¸°ë³¸ê°’ì€ true)
  select: false,
  // ì•„ë¬´ê²ƒë„ ì…ë ¥ì•ˆí–ˆì„ ë–„, ê¸°ë³¸ìœ¼ë¡œ ì…ë ¥ë˜ê²Œ ë˜ëŠ” ê°’
  default: 'default value',
  // ì»¬ëŸ¼ ì¤‘ì—ì„œ ìœ ì¼í•œ ê°’ì´ ë¼ì•¼í•˜ëŠ”ì§€(ê¸°ë³¸ê°’ì€ false), ë³´í†µ íšŒì›ì´ë©”ì¼ ì»¬ëŸ¼ì— ì‚¬ìš©
  unique: false,
})
title: string
```

```ts app.controller.ts
// app.controller.ts ìƒëµ
@Post('users')
postUser() {
  return this.userRepository.save({
    // title: 'test title',
  })
}

@Get('users')
getUsers() {
  return this.userRepository.find({
    select: { id: true, title: true },
  })
}
```

---

## 4. Enum Column

```ts user.entity.ts
export enum Role {
  USER = 'user',
  ADMIN = 'admin',
}

@Entity()
export class UserModel {
  // ìƒëµ
  title: string

  @Column({
    type: 'enum',
    enum: Role,
    default: Role.USER,
  })
  role: Role

  // ìƒëµ
}
```

```ts app.controller.ts
@Post('users')
postUser() {
  return this.userRepository.save({
    // title: 'test title',
    role: Role.ADMIN, // ê´€ë¦¬ì ì—­í• ì„ ë„£ê³ ì‹¶ì„ ë–„
  })
}

// app.controller.tsì˜ selectì˜µì…˜ ì§€ìš°ê¸°
@Get('users')
getUsers() {
  return this.userRepository.find({})
}
```

---

## 5. Entity Embedding

`src/entity/person.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts person.entity.ts
import { Column, Entity, PrimaryColumn } from 'typeorm'

export class Name {
  @Column()
  first: string

  @Column()
  last: string
}

@Entity()
export class StudentModel {
  @PrimaryColumn()
  id: number

  @Column(() => Name)
  name: Name

  @Column()
  class: string
}

@Entity()
export class TeacherModel {
  @PrimaryColumn()
  id: number

  @Column(() => Name)
  name: Name

  @Column()
  salary: number
}
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
// ìƒëµ
@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [UserModel, StudentModel, TeacherModel],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

DBì— ë“¤ì–´ê°„ ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ë³´ë©´, `nameFirst`, `nameLast`ë¡œ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

## 6. Table Inheritance

`src/entity/inheritance.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts inheritance.entity.ts
import { Column, CreateDateColumn, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm'

export class BaseModel {
  @PrimaryGeneratedColumn()
  id: number

  @CreateDateColumn()
  createdAt: Date

  @UpdateDateColumn()
  updateat: Date
}

@Entity()
export class BookModel extends BaseModel {
  @Column()
  name: string
}

@Entity()
export class CarModel extends BaseModel {
  @Column()
  brand: string
}
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        UserModel,
        StudentModel, //
        TeacherModel,
        BookModel,
        CarModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

DBì— ë“¤ì–´ê°„ ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ë³´ë©´, ìƒì†ë°›ì€ ì†ì„±ì´ ë“¤ì–´ê°„ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

í‰ì†Œì—ëŠ” ìœ„ì™€ ê°™ì€ ì¼ë°˜ì ì¸ ìƒì†ì„ ì“°ëŠ” ê²ƒì´ ì¢‹ë‹¤. ë‹¤ë§Œ, êµ³ì´ í•˜ë‚˜ì˜ í…Œì´ë¸”ë¡œ ê´€ë¦¬í•´ì•¼ í•˜ëŠ” ê²½ìš°ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.

```ts inheritance.entity.ts
import {
  ChildEntity,
  Column,
  CreateDateColumn,
  Entity,
  PrimaryGeneratedColumn,
  TableInheritance,
  UpdateDateColumn,
} from 'typeorm'

export class BaseModel {
  @PrimaryGeneratedColumn()
  id: number

  @CreateDateColumn()
  createdAt: Date

  @UpdateDateColumn()
  updateat: Date
}

@Entity()
export class BookModel extends BaseModel {
  @Column()
  name: string
}

@Entity()
export class CarModel extends BaseModel {
  @Column()
  brand: string
}

@Entity()
@TableInheritance({
  column: {
    name: 'type',
    type: 'varchar',
  },
})
export class SingleBaseModel {
  @PrimaryGeneratedColumn()
  id: number

  @CreateDateColumn()
  createdAt: Date

  @UpdateDateColumn()
  updateat: Date
}

@ChildEntity()
export class ComputerModel extends SingleBaseModel {
  @Column()
  brand: string
}

@ChildEntity()
export class AirplaneModel extends SingleBaseModel {
  @Column()
  country: string
}
```

ë§ˆì°¬ê°€ì§€ë¡œ `app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([UserModel]),
    TypeOrmModule.forRoot({
      // ë°ì´í„°ë² ì´ìŠ¤ íƒ€ì…
      type: 'postgres',
      host: '127.0.0.1',
      port: 5808,
      username: 'postgres',
      password: 'postgres',
      database: 'typeormstudy',
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        UserModel,
        StudentModel, //
        TeacherModel,
        BookModel,
        CarModel,
        SingleBaseModel,
        ComputerModel,
        AirplaneModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

DBì— ë“¤ì–´ê°„ ì»¬ëŸ¼ëª…ì„ í™•ì¸í•´ë³´ë©´,
ìì‹ ì»¬ëŸ¼ì´ ë“¤ì–´ê°„ single_base_model í•˜ë‚˜ë§Œ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

---

## 7. Relationship ì´ë¡ 

- [ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ (ê´€ê³„ ì¢…ë¥˜ 1:1 / 1:M / N:M )](https://hanamon.kr/%EA%B4%80%EA%B3%84%ED%98%95-%EB%8D%B0%EC%9D%B4%ED%84%B0%EB%B2%A0%EC%9D%B4%EC%8A%A4-%EC%84%A4%EA%B3%84-%EA%B4%80%EA%B3%84-%EC%A2%85%EB%A5%98/)

---

## 8. 1:1 ê´€ê³„ ì‘ì—…

`src/entity/profile.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts profile.entity.ts
import { Column, Entity, JoinColumn, OneToOne, PrimaryGeneratedColumn } from 'typeorm'
import { UserModel } from './user.entity'

@Entity()
export class ProfileModel {
  @PrimaryGeneratedColumn()
  id: number

  // UserModelì— userì˜ profile ì»¬ëŸ¼ê³¼ 1:1 ì—°ê²°
  @OneToOne(() => UserModel, user => user.profile)
  // ìƒëŒ€ë°© í…Œì´ë¸”ì˜ idë¥¼ ê°€ì§€ê³  ìˆê¸°(ë§Œì•½ ìƒëŒ€ë°©ì´ ê°–ê³ ìˆìœ¼ë©´ ìƒëŒ€ë°©ì´ ì´ í…Œì´ë¸” idë¥¼ ê°€ì§)
  @JoinColumn()
  user: UserModel

  @Column()
  profileImg: string
}
```

ì—°ê²°í•  ëª¨ë¸(`user.entity.ts`)ì— 1:1ë¡œ ì—°ê²°í•  ëª¨ë¸ì„ ì¶”ê°€í•œë‹¤.

```ts user.entity.ts
// ìƒëµ
// ProfileModelì— profileì˜ user ì»¬ëŸ¼ê³¼ 1:1 ì—°ê²°
@OneToOne(() => ProfileModel, profile => profile.user)
profile: ProfileModel
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆ(`ProfileModel`)ì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    // ProfileModel ì¶”ê°€
    TypeOrmModule.forFeature([UserModel, ProfileModel]),
    TypeOrmModule.forRoot({
      // ìƒëµ
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        // ìƒëµ
        ProfileModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
```

user ì—”í‹°í‹°ì˜ titleì„ ì§€ìš°ê³  ëŒ€ì‹ , email ì»¬ëŸ¼ì„ ì¶”ê°€í•œë‹¤.
ê¸°ì¡´ ë°ì´í„°ê°€ ì €ì¥ë˜ì–´ìˆëŠ” ê³³(postgres-data)ì„ ì§€ì› ë‹¤ê°€ ë‹¤ì‹œ ìƒì„±í•œë‹¤.(`docker-compose up`)

```ts user.entity.ts
// user.entity.ts
// title: stringì€ ì£¼ì„ì²˜ë¦¬
@Column()
email: string
```

app ì»¨íŠ¸ë¡¤ëŸ¬ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ìˆ˜ì •í•œë‹¤.

```ts app.controller.ts
// ìƒëµ
@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
    @InjectRepository(ProfileModel)
    private readonly profileRepository: Repository<ProfileModel>,
  ) {}

  @Post('users')
  postUser() {
    return this.userRepository.save({})
  }

  @Get('users')
  getUsers() {
    return this.userRepository.find({
      // ì—°ë™ëœ ë°ì´í„° ì»¬ëŸ¼(profile)ë„ ê°€ì ¸ì˜¤ê¸°
      relations: {
        profile: true,
      },
    })
  }

  @Patch('users/:id')
  async patchUser(@Param('id') id: string) {
    const user = await this.userRepository.findOne({
      where: { id: parseInt(id) },
    })

    return this.userRepository.save({
      ...user,
    })
  }

  @Post('user/profile')
  async createUserAndProfile() {
    const user = await this.userRepository.save({
      email: 'asd@gmail.ai',
    })
    const profile = await this.profileRepository.save({
      profileImg: 'asdf.png',
      user,
    })
    return user
  }
}
```

---

## 9. M:1 & 1:M ê´€ê³„ êµ¬í˜„

`src/entity/post.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts post.entity.ts
import { Column, Entity, ManyToOne, PrimaryGeneratedColumn } from 'typeorm'
import { UserModel } from './user.entity'

@Entity()
export class PostModel {
  @PrimaryGeneratedColumn()
  id: number

  // 1:M ê´€ê³„ì´ë‹ˆ postsë¡œ ë³µìˆ˜í˜•ìœ¼ë¡œ ì„ ì–¸
  @ManyToOne(() => UserModel, user => user.posts)
  author: UserModel

  @Column()
  title: string
}
```

í…Œì´ë¸”ì´ ì–´ëŠ ì§€ì ì„ ë°”ë¼ë³´ëƒì— ë”°ë¼ M:1ì´ë‚˜ 1:Mì´ ëœë‹¤.

```ts user.entity.ts
// user.entity.ts ìƒëµ
@OneToMany(() => PostModel, post => post.author)
posts: PostModel[]
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆ(`PostModel`)ì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
@Module({
  imports: [
    TypeOrmModule.forFeature([
      UserModel,
      ProfileModel,
      PostModel, // ì¶”ê°€
    ]),
    TypeOrmModule.forRoot({
      // ìƒëµ
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        // ìƒëµ
        PostModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
```

í™•ì¸ìš© apië¥¼ `app.controller.ts`ì— ë§Œë“¤ê³  í¬ìŠ¤íŠ¸ë§¨ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.

```ts app.controller.ts
// ìƒëµ

@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
    @InjectRepository(ProfileModel)
    private readonly profileRepository: Repository<ProfileModel>,
    @InjectRepository(PostModel)
    private readonly postRepository: Repository<PostModel>,
  ) {}

  // ìƒëµ
  @Get('users')
  getUsers() {
    return this.userRepository.find({
      relations: {
        profile: true,
        posts: true, // ì¶”ê°€
      },
    })
  }

  @Post('user/post')
  async createUserAndPost() {
    const user = await this.userRepository.save({
      email: 'postuser@gmail.ai',
    })
    await this.postRepository.save({
      author: user,
      title: 'post 1',
    })
    await this.postRepository.save({
      author: user,
      title: 'post 2',
    })

    return user
  }
}
```

---

## 10. M : M ê´€ê³„ êµ¬í˜„

`src/entity/tag.entity.ts` íŒŒì¼ì„ ë§Œë“ ë‹¤.

```ts tag.entity.ts
import { Column, Entity, ManyToMany, PrimaryGeneratedColumn } from 'typeorm'
import { PostModel } from './post.entity'

@Entity()
export class TagModel {
  @PrimaryGeneratedColumn()
  id: number

  // M:M ì—°ê²°ì´ê¸° ë•Œë¬¸ì— ë‘˜ ë‹¤ ë³µìˆ˜ë¡œ ì„ ì–¸
  @ManyToMany(() => PostModel, post => post.tags)
  posts: PostModel[]

  @Column()
  name: string
}
```

`post.entity.ts`ì— tagsë¥¼ ë‹¤ëŒ€ë‹¤ ê´€ê³„ë¡œ ì—°ê²°í•©ë‹ˆë‹¤.

```ts post.entity.ts
import { Column, Entity, JoinTable, ManyToMany, ManyToOne, PrimaryGeneratedColumn } from 'typeorm'
import { UserModel } from './user.entity'
import { TagModel } from './tag.entity'

@Entity()
export class PostModel {
  @PrimaryGeneratedColumn()
  id: number

  // 1:M ê´€ê³„ì´ë‹ˆ postsë¡œ ë³µìˆ˜í˜•ìœ¼ë¡œ ì„ ì–¸
  @ManyToOne(() => UserModel, user => user.posts)
  author: UserModel

  // M:M ì—°ê²°ì´ê¸° ë•Œë¬¸ì— ë‘˜ ë‹¤ ë³µìˆ˜ë¡œ ì„ ì–¸
  @ManyToMany(() => TagModel, tag => tag.posts)
  // M:M ì—°ê²°ì—ì„œ JoinTableì€ ë‘˜ ì¤‘ í•˜ë‚˜ ì•„ë¬´êµ°ë° ì„ ì–¸í•´ì£¼ë©´ ëœë‹¤
  @JoinTable()
  tags: TagModel[]

  @Column()
  title: string
}
```

`app.module.ts`ì— ìƒì„±í•œ ëª¨ë“ˆ(`TagModel`)ì„ ì¶”ê°€í•œë‹¤.

```ts app.module.ts
// ìƒëµ
@Module({
  imports: [
    TypeOrmModule.forFeature([
      UserModel,
      ProfileModel, //
      PostModel,
      TagModel,
    ]),
    TypeOrmModule.forRoot({
      // ìƒëµ
      // entitiesí´ë”ì— ì‘ì„±í•œ Model ê°€ì ¸ì˜¤ê¸°
      entities: [
        // ìƒëµ
        TagModel,
      ],
      synchronize: true,
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

app ì»¨íŠ¸ë¡¤ëŸ¬ì— tag ìš”ì²­ì„ ì¶”ê°€í•œë‹¤.

```ts app.controller.ts
// ìƒëµ
@Controller()
export class AppController {
  constructor(
    @InjectRepository(UserModel)
    private readonly userRepository: Repository<UserModel>,
    @InjectRepository(ProfileModel)
    private readonly profileRepository: Repository<ProfileModel>,
    @InjectRepository(PostModel)
    private readonly postRepository: Repository<PostModel>,
    @InjectRepository(TagModel)
    private readonly tagRepository: Repository<TagModel>,
  ) {}

  // ìƒëµ

  @Post('posts/tags')
  async createPostsTags() {
    const post1 = await this.postRepository.save({
      title: 'NestJS ìˆ˜ì—…',
    })

    const post2 = await this.postRepository.save({
      title: 'í”„ë¡œê·¸ë˜ë° ìˆ˜ì—…',
    })

    const tag1 = await this.tagRepository.save({
      name: 'Javascript',
      posts: [post1, post2],
    })

    const tag2 = await this.tagRepository.save({
      name: 'Typescript',
      posts: [post1],
    })

    const post3 = await this.postRepository.save({
      title: 'NextJS ìˆ˜ì—…',
      tags: [tag1, tag2],
    })

    return true
  }

  @Get('posts')
  getPosts() {
    return this.postRepository.find({
      relations: {
        tags: true,
      },
    })
  }

  @Get('tags')
  getTags() {
    return this.tagRepository.find({
      relations: {
        posts: true,
      },
    })
  }
}
```

í¬ìŠ¤íŠ¸ë§¨ìœ¼ë¡œ ìš”ì²­í•´ í™•ì¸í•´ë³´ì„¸ìš”.

---

## 11. Relation Options

postgres-data íŒŒì¼ì„ ì§€ì›Œ ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.
`user.entity.ts`ì—ì„œ ê´€ê³„ë¡œ ë„£ì„ ìˆ˜ ìˆëŠ” ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.

```ts user.entity.ts
// ProfileModelì— profileì˜ user ì»¬ëŸ¼ê³¼ 1:1 ì—°ê²°
@OneToOne(() => ProfileModel, profile => profile.user, {
  // find() ì‹¤í–‰í•  ë•Œë§ˆë‹¤ í•­ìƒ ê°™ì´ ê°€ì ¸ì˜¬ relation ì„¤ì •(ê¸°ë³¸ê°’ false)
  eager: true,
  // ì €ì¥í•  ë–„, relationì„ í•œ ë²ˆì— ê°™ì´ ì €ì¥(ê¸°ë³¸ê°’ false)
  cascade: true,
  // nullì´ ê°€ëŠ¥í•œì§€ ì—¬ë¶€(ê¸°ë³¸ê°’ true)
  nullable: true,
  // ê´€ê³„ë¥¼ ì‚­ì œí–ˆì„ ë–„, ì–´ë–»ê²Œ ì‚­ì œí•  ê²ƒì¸ì§€
  // - NO ACTION : ì•„ë¬´ê²ƒë„ ì•ˆí•¨
  // - CASCADE : ì°¸ì¡°í•˜ëŠ” rowë„ ê°™ì´ ì‚­ì œ
  // - SET NULL : ì°¸ì¡°í•˜ëŠ” rowì—ì„œ ì°¸ì¡° idë¥¼ nullë¡œ ë³€ê²½
  // - set default : ê¸°ë³¸ ì„¸íŒ…ìœ¼ë¡œ ì„¤ì •(í…Œì´ë¸”ì˜ ê¸°ë³¸ ì„¸íŒ…)
  // - RESTRICT : ì°¸ì¡°í•˜ê³  ìˆëŠ” rowê°€ ìˆëŠ” ê²½ìš° ì°¸ì¡°ë‹¹í•˜ëŠ” row ì‚­ì œ ë¶ˆê°€
  onDelete: 'NO ACTION',
})
profile: ProfileModel
```

ê´€ê³„ ì‚­ì œ ì˜µì…˜ í…ŒìŠ¤íŠ¸ìš©ì„ `app.controller.ts`ì— ë„£ì–´ì„œ í™•ì¸í•´ë³¸ë‹¤

```ts app.controller.ts
@Delete('user/profile/:id')
async deleteProfile(@Param('id') id: string) {
  await this.profileRepository.delete(+id)
}
```

---

## 12. FindManyOptions íŒŒë¼ë¯¸í„°

`app.controller.ts`ì—ì„œ find()ì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.

```ts app.controller.ts
@Get('users')
getUsers() {
  return this.userRepository.find({
    // ì–´ë–¤ ì†ì„±ì„ ì„ íƒí• ì§€ (ê¸°ë³¸ì€ ëª¨ë“  ì†ì„±ì„ ê°€ì ¸ì˜´)
    // selectë¥¼ ì •ì˜í•˜ë©´, ì •ì˜í•œ ì†ì„±ë§Œ ê°€ì ¸ì˜¨ë‹¤
    select: {
      id: true,
      email: true,
      version: true,
      profile: {
        id: true,
      },
    },
    // í•„í„°ë§í•  ì¡°ê±´ì„ ì…ë ¥í•œë‹¤ ({}ì•ˆì—ì„œëŠ” ì „ë¶€ and ì¡°ê±´ìœ¼ë¡œ í•„í„°ë§)
    where: [
      // idê°€ 3ì´ê±°ë‚˜ or versionì´ 1
      {
        id: 3,
      },
      {
        version: 1,
      },
    ],
    // ------ ë‹¤ë¥¸ ê´€ê³„ë¥¼ í•„í„°ë§í•˜ëŠ” ë²•
    // where: {
    //   profile: {
    //     id: 3,
    //   },
    // },
    // ê´€ê³„ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë²•
    relations: {
      profile: true,
    },
    // ì˜¤ë¦„ì°¨(ASC)-ê¸°ë³¸, ë‚´ë¦¼ì°¨(DESC)
    order: {
      id: 'DESC',
    },
    // ì²˜ìŒ ëª‡ ê°œë¥¼ ì œì™¸í•  ì§€ (ê¸°ë³¸ì€ 0) 1ì´ë©´ 1ê°œ ìŠ¤í‚µ
    skip: 0,
    // ëª‡ ê°œë¥¼ ê°€ì ¸ì˜¬ì§€ (ê¸°ë³¸ê°’ì€ 0, ì „ì²´) 1ì´ë©´ 1ê°œë§Œ ê°€ì ¸ì˜´
    take: 0,
  })
}
```

---

## 13. Typeorm ìœ í‹¸ë¦¬í‹° ë„êµ¬

`app.controller.ts`ì—ì„œ find()ì— ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ìœ í‹¸ë¦¬í‹° ì˜µì…˜ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.

```ts app.controller.ts
@Post('users')
async postUser() {
  for (let i = 0; i < 100; i++) {
    await this.userRepository.save({
      email: `user-${i}@google.com`,
    })
  }
}

@Get('users')
getUsers() {
  return this.userRepository.find({
    where: {
      // ğŸ“Œ (1) 1ì´ ì•„ë‹Œ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      // id: Not(1),
      // ğŸ“Œ (2) 30 ë¯¸ë§Œì˜ ì ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      // id: LessThan(30),
      // ğŸ“Œ (3) 30 ì´í•˜ì˜ ì ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      // id: LessThanOrEqual(30),
      // ğŸ“Œ (4) 30 ì´ˆê³¼ì˜ ë§ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      // id: MoreThan(30)
      // ğŸ“Œ (5) 30 ì´ìƒì˜ ë§ì€ ê²½ìš° ê°€ì ¸ì˜¤ê¸°
      // id: MoreThanOrEqual(30)
      // ğŸ“Œ (6) ê°™ì€ ê²½ìš°
      // id : Equal(30)
      // ğŸ“Œ (7) ìœ ì‚¬ê°’, %ë¡œ ìœ ì‚¬í•œ ë¬¸ì ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„í•¨)
      // email: Like('%0@google%'),
      // ğŸ“Œ (8) ìœ ì‚¬ê°’, %ë¡œ ìœ ì‚¬í•œ ë¬¸ì ì°¾ê¸° (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ì•ˆí•¨)
      // email: ILike('%GOOGLE%'),
      // ğŸ“Œ (9) ì‚¬ì´ê°’, 10~15ë²ˆ ì‚¬ì´ê¹Œì§€ì˜ ê°’
      // id: Between(10, 15),
      // ğŸ“Œ (10) í•´ë‹¹ë˜ëŠ” ì—¬ëŸ¬ ê°œì˜ ê°’, 1, 3, 5, 7, 99ì˜ id ì°¾ê¸°
      // id: In([1, 3, 5, 7, 99]),
      // ğŸ“Œ (11) IDê°€ nullì¸ ê²½ìš° ì°¾ê¸°
      id: IsNull(),
    },
    // ì£¼ì„ ìƒëµ
  })
}
```

ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³ , 1~100ê°œì˜ ì„ì˜ì˜ ìœ ì €ë¥¼ ë§Œë“  í›„, ê°ê°ì˜ ìœ í‹¸ë¦¬í‹°ë¥¼ í™•ì¸í•œë‹¤.

---

## 14. í”íˆ ì‚¬ìš©ë˜ëŠ” ë©”ì„œë“œ

`user.entity.ts`ì— count ì»¬ëŸ¼ì„ ì¶”ê°€í•œë‹¤.

```ts
@Column({ default: 0 })
count: number
```

app ì»¨íŠ¸ë¡¤ëŸ¬ì— sample ìš”ì²­ì„ ë§Œë“¤ê³  ì‹¤ìŠµí•œë‹¤.

```ts app.controller.ts
 @Post('sample')
async sample() {
  // ğŸ“Œ (1) ëª¨ë¸ì— í•´ë‹¹ë˜ëŠ” ê°ì²´ ìƒì„± - ì €ì¥ì€ ì•ˆí•¨
  // const user1 = await this.userRepository.create({
  //   email: 'test@gmail.ai',
  // })

  // ğŸ“Œ (2) ëª¨ë¸ì— í•´ë‹¹ë˜ëŠ” ê°ì²´ ìƒì„± - DBì— ì €ì¥í•¨
  // const user2 = await this.userRepository.save({
  //   email: 'test@gmail.ai',
  // })

  /*** ğŸ“Œ (3) preload
   * ì…ë ¥ëœ ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ DBì— ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ê³ ,
   * ì¶”ê°€ì…ë ¥ëœ ê°’ìœ¼ë¡œ DBì— ê°€ì ¸ì˜¨ ê°’ë“¤ì„ ëŒ€ì²´í•¨
   * ì €ì¥í•˜ì§€ëŠ” ì•ŠìŒ
   */
  // const user3 = await this.userRepository.preload({
  //   id: 101,
  //   email: 'testë³€ê²½-ì €ì¥x@gmail.ai',
  // })

  // ğŸ“Œ (4) ì‚­ì œí•˜ê¸°
  // await this.userRepository.delete(101)

  // ğŸ“Œ (5) ìˆ«ìí˜• ì»¬ëŸ¼ ì¦ê°€ (idê°€ 1ì¸ count ì»¬ëŸ¼ì„ 2ë§Œí¼ ì¦ê°€)
  // await this.userRepository.increment(
  //   { id: 1 }, //
  //   'count',
  //   2,
  // )

  // ğŸ“Œ (6) ìˆ«ìí˜• ì»¬ëŸ¼ ê°ì†Œ (idê°€ 1ì¸ count ì»¬ëŸ¼ì„ 1ë§Œí¼ ê°ì†Œ)
  // await this.userRepository.decrement(
  //   { id: 1 }, //
  //   'count',
  //   1,
  // )

  // ğŸ“Œ (7) ê°œìˆ˜ ì¹´ìš´íŒ…í•˜ê¸°
  // const count = await this.userRepository.count({
  //   where: {
  //     email: ILike('%0%'),
  //   },
  // })

  // ğŸ“Œ (8) sum : ì†ì„±ë“¤ì˜ ê°’ ì „ë¶€ í•©ì¹˜ê¸°
  // const sum = await this.userRepository.sum('count', {
  //   email: ILike('%0%'),
  // })

  // ğŸ“Œ (9) average : ì†ì„±ì˜ í‰ê· ê°’ êµ¬í•˜ê¸°
  // const average = await this.userRepository.average('count', {
  //   id: LessThan(4),
  // })

  // ğŸ“Œ (10) min : ì†ì„±ì˜ ìµœì†Œê°’ êµ¬í•˜ê¸°
  // const min = await this.userRepository.minimum('count', {
  //   id: LessThan(4),
  // })

  // ğŸ“Œ (10) max : ì†ì„±ì˜ ìµœëŒ€ê°’ êµ¬í•˜ê¸°
  // const max = await this.userRepository.maximum('count', {
  //   id: LessThan(4),
  // })

  // ğŸ“Œ (11) findì™€ findOneë„ ìˆìŒ(ë§ì´ ë‹¤ë¤˜ìœ¼ë‹ˆ ìƒëµ)
  // const userOne = await this.userRepository.findOne({
  //   where: { id: 3 },
  // })

  // ğŸ“Œ (12) 3ê°œì˜ ê°’ì„ ê°€ì ¸ì˜¤ëŠ”ë°, ì „ì²´ í–‰ ê°œìˆ˜ë„ ë°˜í™˜í•´ì¤Œ
  const usersAndCount = await this.userRepository.findAndCount({
    take: 3,
  })

  return usersAndCount
}
```
